using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Globalization;
using CsvHelper;
using Dapper;
using System.IO;
using System.Linq;

namespace AbstractInsertExample
{
    // Userエンティティクラス
    public class User
    {
        public string Name { get; set; } = string.Empty;  // ユーザー名
        public string Email { get; set; } = string.Empty; // メールアドレス
    }

    // Postエンティティクラス
    public class Post
    {
        public string Title { get; set; } = string.Empty;   // 投稿のタイトル
        public string Content { get; set; } = string.Empty; // 投稿の内容
    }

    // 抽象クラス：共通のDB操作を定義
    public abstract class AbstractDatabaseHandler<T>
    {
        protected abstract string TableName { get; }
        protected abstract string InsertQuery { get; }
        protected abstract string ConnectionString { get; }

        // 複数レコードの挿入
        public void InsertEntities(IEnumerable<T> entities)
        {
            foreach (var entity in entities)
            {
                int newId = InsertEntity(entity); // 単一レコードを挿入し、ID取得
                Console.WriteLine($"テーブル {TableName} に挿入されました。生成されたID: {newId}");
            }
        }

        // 単一レコードの挿入とID取得
        private int InsertEntity(T entity)
        {
            var parameters = CreateParameters(entity); // パラメータ作成
            return ExecuteInsert(InsertQuery, parameters); // 挿入とID取得
        }

        // クエリを実行し、生成されたIDを取得
        private int ExecuteInsert(string query, object parameters)
        {
            using (IDbConnection db = new SqlConnection(ConnectionString))
            {
                db.Open();
                using var transaction = db.BeginTransaction();
                try
                {
                    var id = db.ExecuteScalar<int>(query, parameters, transaction: transaction);
                    transaction.Commit(); // コミット
                    return id;
                }
                catch
                {
                    transaction.Rollback(); // エラー時にロールバック
                    throw;
                }
            }
        }

        // エンティティのプロパティをパラメータに変換
        private object CreateParameters(T entity)
        {
            var parameters = new Dictionary<string, object>();
            foreach (var property in typeof(T).GetProperties())
            {
                parameters.Add(property.Name, property.GetValue(entity));
            }
            return parameters;
        }

        // 外部CSVファイルからレコードを取得
        public IEnumerable<T> GetRecords(string filePath)
        {
            using var reader = new StreamReader(filePath);
            using var csv = new CsvReader(reader, CultureInfo.InvariantCulture);

            // CSVファイルの内容をT型のリストに変換して返す
            return csv.GetRecords<T>().ToList();
        }
    }

    // Userテーブル用のDBハンドラークラス
    public class UserDatabaseHandler : AbstractDatabaseHandler<User>
    {
        protected override string TableName => "Users";

        protected override string InsertQuery =>
            "INSERT INTO Users (Name, Email) VALUES (@Name, @Email); SELECT SCOPE_IDENTITY();";

        protected override string ConnectionString =>
            "Data Source=Server;Initial Catalog=YourDatabase;User ID=your_user;Password=your_password;";
    }

    // Postテーブル用のDBハンドラークラス
    public class PostDatabaseHandler : AbstractDatabaseHandler<Post>
    {
        protected override string TableName => "Posts";

        protected override string InsertQuery =>
            "INSERT INTO Posts (Title, Content) VALUES (@Title, @Content); SELECT SCOPE_IDENTITY();";

        protected override string ConnectionString =>
            "Data Source=Server;Initial Catalog=YourDatabase;User ID=your_user;Password=your_password;";
    }

    // メインプログラム
    public class Program
    {
        public static void Main(string[] args)
        {
            try
            {
                // Userデータの挿入
                var userHandler = new UserDatabaseHandler();
                string userCsvPath = "/path/to/your/users.csv"; // User用CSVファイルのパス
                var users = userHandler.GetRecords(userCsvPath); // Userレコード取得
                userHandler.InsertEntities(users); // Userデータを挿入

                // Postデータの挿入
                var postHandler = new PostDatabaseHandler();
                string postCsvPath = "/path/to/your/posts.csv"; // Post用CSVファイルのパス
                var posts = postHandler.GetRecords(postCsvPath); // Postレコード取得
                postHandler.InsertEntities(posts); // Postデータを挿入

                Console.WriteLine("全てのデータが正常に挿入されました。");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"エラーが発生しました: {ex.Message}");
            }

            Console.WriteLine("プログラム終了。");
        }
    }
}